name: Sync Open Discovery PRs

on:
  push:
    branches: [main]
    paths:
      - 'data/projects.json'
  workflow_dispatch:

jobs:
  sync-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Sync Open Discovery PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main

          # Get all open PRs with the discovery label
          PRS=$(gh pr list --label "discovery" --state open --json number,title,headRefName)
          
          echo "Found $(echo "$PRS" | jq '. | length') open discovery PRs"
          
          # Iterate through each PR and rebuild branch on top of current main.
          # This guarantees a conflict-free branch state.
          echo "$PRS" | jq -c '.[]' | while read -r pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            PR_BRANCH=$(echo "$pr" | jq -r '.headRefName')
            PR_TITLE=$(echo "$pr" | jq -r '.title')
            REPO_NAME=$(echo "$PR_TITLE" | sed 's/^Auto-discover: //')
            
            echo "Rebuilding PR #$PR_NUM ($REPO_NAME) on branch $PR_BRANCH..."
            
            git fetch origin "$PR_BRANCH"
            git checkout -B "$PR_BRANCH" "origin/$PR_BRANCH"

            # Rebase-by-rebuild: reset branch to latest main, then regenerate single-repo change.
            git reset --hard origin/main
            deno run -A scripts/add.ts "$REPO_NAME"
            deno run -A scripts/sync-data.ts

            git add data/projects.json src/public/data/projects.json
            if git diff --cached --quiet; then
              echo "No delta for $REPO_NAME after rebuild; already present on main."
              git checkout main
              continue
            fi
            git commit -m "chore: sync discovery branch for $REPO_NAME"
            
            # Force-push rebuilt branch so PR is always conflict-free against main.
            git push --force-with-lease origin "$PR_BRANCH"
            
            # Back to main
            git checkout main
          done
