name: Discover Projects

on:
  schedule:
    - cron: "0 12 * * *" # Daily at 12:00 UTC
  workflow_dispatch: # Manual trigger

jobs:
  discover:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Discover and Add
        id: discover
        run: |
          FOUND_REPOS=$(deno run -A scripts/discover.ts 5)
          echo "found_repos=$FOUND_REPOS" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Process Found Repos
      - name: Process Found Repos
        run: |
          REPOS='${{ steps.discover.outputs.found_repos }}'
          echo "Found metadata for $(echo "$REPOS" | jq '. | length') repos"
          
          echo "$REPOS" | jq -c '.[]' | while read -r project; do
            if [ -z "$project" ]; then continue; fi
            
            REPO=$(echo "$project" | jq -r '.full_name')
            DESC=$(echo "$project" | jq -r '.description // "No description"')
            STARS=$(echo "$project" | jq -r '.stars')
            TOOLS_MD=$(echo "$project" | jq -r '.aiTools | map("- **\(.name)** (via \(.detected_via))\(if .evidence_url then " [Evidence](\(.evidence_url))" else "" end)") | join("\n")')
            
            echo "Processing $REPO..."
            # Clean up repo name for branch name
            CLEAN_REPO=$(echo "$REPO" | tr '/' '-')
            BRANCH_NAME="auto-discover-$CLEAN_REPO"
            
            # Add the project
            deno run -A scripts/add.ts "$REPO"
            
            # Sync data to public folder for consistency
            deno run -A scripts/sync-data.ts
            
            # Commit and push
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            
            # Check if there are changes
            if git diff --quiet data/projects.json; then
              echo "No changes for $REPO, skipping."
              continue
            fi

            git checkout -B "$BRANCH_NAME"
            git add data/projects.json src/public/data/projects.json
            git commit -m "feat: auto-discover $REPO"
            git push origin "$BRANCH_NAME" --force
            
            # Ensure labels exist
            gh label create "discovery" --color "0E8A16" --description "Automatically discovered projects" || echo "Label exists"
            gh label create "automated pr" --color "FBCA04" --description "PRs created by automation" || echo "Label exists"

            # Create rich PR body
            PR_BODY=$(cat <<EOF
## Auto-discovery: $REPO

A new "Vibe Coded" project has been discovered.

- **Description**: $DESC
- **Stars**: â­ $STARS
- **Detected AI Tools**:
$TOOLS_MD

### Review Instructions
- **Approve**: Merge this PR to add the project to the registry.
- **Deny**: Close this PR without merging. This will automatically add the repository to the denylist so it isn't discovered again.

_Automatically generated by Vibe Coded Discovery_
EOF
)

            # Create PR
            gh pr create --title "Auto-discover: $REPO" --body "$PR_BODY" --base main --head "$BRANCH_NAME" --label "automated pr,discovery" || \
            gh pr create --title "Auto-discover: $REPO" --body "$PR_BODY" --base main --head "$BRANCH_NAME" || \
            echo "PR already exists or could not be created for $REPO"
            
            # Switch back to main for next iteration
            git checkout main
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
